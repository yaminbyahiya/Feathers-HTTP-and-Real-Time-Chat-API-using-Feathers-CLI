"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.generate = void 0;
const pinion_1 = require("@feathershq/pinion");
const commons_1 = require("../../commons");
const promises_1 = require("fs/promises");
const path_1 = __importDefault(require("path"));
const template = ({ database }) => /* ts */ `// For more information about this file see https://dove.feathersjs.com/guides/cli/databases.html
import knex from 'knex'
import type { Knex } from 'knex'
import type { Application } from './declarations'

declare module './declarations' {
  interface Configuration {
    ${database}Client: Knex
  }
}

export const ${database} = (app: Application) => {
  const config = app.get('${database}')
  const db = knex(config!)

  app.set('${database}Client', db)
}
`;
const knexfile = ({ lib, language, database }) => /* ts */ `// For more information about this file see https://dove.feathersjs.com/guides/cli/databases.html
import { app } from './${lib}/app'

// Load our database connection info from the app configuration
const config = app.get('${database}')

${language === 'js' ? 'export default config' : 'module.exports = config'}
`;
const importTemplate = ({ database }) => `import { ${database} } from './${database}'`;
const configureTemplate = ({ database }) => `app.configure(${database})`;
const toAppFile = (0, pinion_1.toFile)(({ lib }) => [lib, 'app']);
const generate = (ctx) => (0, pinion_1.generator)(ctx)
    .then((0, commons_1.renderSource)(template, (0, pinion_1.toFile)(({ lib, database }) => [lib, database])))
    .then((0, commons_1.renderSource)(knexfile, (0, pinion_1.toFile)('knexfile')))
    .then((0, pinion_1.mergeJSON)({
    scripts: {
        migrate: 'knex migrate:latest',
        'migrate:make': 'knex migrate:make',
        test: 'cross-env NODE_ENV=test npm run migrate && npm run mocha'
    }
}, (0, pinion_1.toFile)('package.json')))
    .then((0, commons_1.injectSource)(importTemplate, (0, pinion_1.before)('import { services } from'), toAppFile))
    .then((0, commons_1.injectSource)(configureTemplate, (0, pinion_1.before)('app.configure(services)'), toAppFile))
    .then(async (ctx) => {
    await (0, promises_1.mkdir)(path_1.default.join(ctx.cwd, 'migrations'));
    return ctx;
});
exports.generate = generate;
//# sourceMappingURL=knex.tpl.js.map